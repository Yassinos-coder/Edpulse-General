<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Style for active navigation and search highlighting
    const style = document.createElement("style");
    style.textContent = `
            .my_nav-item.active {
                font-weight: bold;
            }
            .search-highlight {
                background-color: #ded9d9;
                border-radius: 2px;
                padding: 0 2px;
            }
        `;
    document.head.appendChild(style);

    // Initialize elements
    const searchInput = document.getElementById("searchInput");
    const contentArea = document.querySelector(".my_content");
    const navItems = document.querySelectorAll(".my_nav-item");
    let sections = [];

    function initializeSections() {
      sections = [];
      navItems.forEach((item) => {
        const sectionId = item.getAttribute("href");
        const section = document.querySelector(sectionId);
        if (section && section.id !== "signature-contrat") {
          sections.push({
            element: section,
            navItem: item,
          });
        }
      });
    }

    function highlightNavItem() {
      const scrollPosition = contentArea.scrollTop;
      const containerHeight = contentArea.clientHeight;

      navItems.forEach((item) => item.classList.remove("active"));

      for (let i = 0; i < sections.length; i++) {
        const section = sections[i];
        const sectionTop = section.element.offsetTop - contentArea.offsetTop;
        const sectionBottom = sectionTop + section.element.offsetHeight;

        if (
          scrollPosition >= sectionTop - 50 &&
          scrollPosition < sectionBottom
        ) {
          section.navItem.classList.add("active");
          break;
        }

        if (
          i === sections.length - 1 &&
          scrollPosition + containerHeight >= contentArea.scrollHeight
        ) {
          section.navItem.classList.add("active");
        }
      }
    }

    function removeHighlights(element) {
      const highlights = element.querySelectorAll(".search-highlight");
      highlights.forEach((highlight) => {
        const text = document.createTextNode(highlight.textContent);
        highlight.parentNode.replaceChild(text, highlight);
      });
    }

    function highlightText(element, searchTerm) {
      if (!searchTerm) return;

      // Skip if element is form or signature-contrat section
      if (
        element.id === "fluent-form-entente" ||
        element.id === "signature-contrat" ||
        element.closest("#fluent-form-entente") ||
        element.closest("#signature-contrat")
      ) {
        return;
      }

      const walker = document.createTreeWalker(
        element,
        NodeFilter.SHOW_TEXT,
        null,
        false
      );

      const nodes = [];
      let node;
      while ((node = walker.nextNode())) {
        nodes.push(node);
      }

      nodes.forEach((node) => {
        const text = node.textContent;
        if (
          text.trim() &&
          text.toLowerCase().includes(searchTerm.toLowerCase())
        ) {
          const span = document.createElement("span");
          span.innerHTML = text.replace(
            new RegExp(`(${searchTerm})`, "gi"),
            '<span class="search-highlight">$1</span>'
          );
          node.parentNode.replaceChild(span, node);
        }
      });
    }

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    let noResultsDiv = null;

    function performSearch() {
      const searchTerm = searchInput.value.trim().toLowerCase();

      // Remove any existing "no results" message
      if (noResultsDiv) {
        noResultsDiv.remove();
        noResultsDiv = null;
      }

      // Get all searchable sections
      const allSections = contentArea.querySelectorAll(
        "section.elementor-inner-section"
      );
      let hasResults = false;

      allSections.forEach((section) => {
        // Skip form and signature sections
        if (
          section.querySelector("#fluent-form-entente") ||
          section.id === "signature-contrat"
        ) {
          return;
        }

        // Remove existing highlights
        removeHighlights(section);

        if (!searchTerm) {
          // Show all sections when search is cleared
          section.style.display = "";
          return;
        }

        const sectionText = section.textContent.toLowerCase();
        if (sectionText.includes(searchTerm)) {
          section.style.display = "";
          highlightText(section, searchTerm);
          hasResults = true;
        } else {
          section.style.display = "none";
        }
      });

      // Show "no results" message if needed
      if (searchTerm && !hasResults) {
        noResultsDiv = document.createElement("div");
        noResultsDiv.style.textAlign = "center";
        noResultsDiv.style.padding = "20px";
        noResultsDiv.textContent = "Aucun résultat trouvé";

        // Insert before the form
        const form = contentArea.querySelector("#fluent-form-entente");
        const insertBefore = form ? form.closest("section") : null;
        if (insertBefore) {
          insertBefore.parentNode.insertBefore(noResultsDiv, insertBefore);
        } else {
          contentArea.appendChild(noResultsDiv);
        }
      }

      highlightNavItem();
    }

    // Initialize
    initializeSections();
    contentArea.addEventListener("scroll", highlightNavItem);
    searchInput.addEventListener("input", debounce(performSearch, 150));
    highlightNavItem();
  });
</script>
